= Configure Queues
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images/


A _queue_ is a temporary storage area for a message. You can create queues, FIFO queues, and dead letter queues in Anypoint Platform. You can also send and receive messages from a queue in Anypoint Studio.

Using Anypoint MQ, you can create two types of queue: 

* Standard queue
+
These queues don't guarantee a specific message order. Standard queues are the best fit for applications where messages must be delivered quickly.
+
Anypoint MQ supports up to 120,000 in-flight messages per standard queue.

* FIFO (first in, first out) queue
+
These queues ensure that your messages arrive in order. FIFO queues are the best fit for applications requiring strict message ordering and exactly-once delivery, but where message delivery speed is of less importance. See <<FIFO Queues>>.
+
Anypoint MQ limits FIFO queues to 10 in-flight messages per FIFO queue.

You can assign either queue type as a dead letter queue. See <<Dead Letter Queues>>.

== Prerequisites

You must create an environment, user access, and roles for accessing Anypoint MQ before configuring queues. See xref:mq-access-management.adoc[Configure Environment, User, and Role Access].


== Create a Queue

To create a queue or FIFO queue:

. Log into Anypoint Platform.
. Click *MQ* in the left navigation bar or the main Anypoint Platform screen.
. Click *Destinations*.
. Click the blue plus-circle icon.
+
image::mq-blue-create.png[]
+
. Select *Queue* or *FIFO Queue*.
+
For *Exchange*, see xref:mq-exchanges.adoc[Configure Message Exchanges].
. Fill in the fields in *Create Queue* or *Create FiFO Queue*.
+
image::mq-create-queues.png[]
+
** *ID* specifies the queue name.
+
Queue names can contain up to 127 alphanumeric characters (a-z, A-Z, 0-9), period (.), and hyphens (-). They cannot contain spaces or other characters. 
+
** *Message TTL* (Time to live) specifies how long unprocessed messages persist before being deleted. 
+
The maximum TTL for a message is 2 weeks.
** *Message Lock Default TTL* specifies how long a message waits before being put back into the queue in the event of  server failure when the message is not acknowledged.
+
The lock makes the message unavailable to other apps while locked, but does not block other messages from being read.
+
The maximum Lock TTL is 12 hours.
** *Assign Default Delivery Delay* specifies how long to delay delivery for messages sent to the queue.
+
You can specify to delay message delivery in milliseconds, seconds, minutes, hours, or days. When you send a message, you can override the default delivery delay. See xref:mq-understanding.adoc#delay_queues[Delay queues].
** *Encryption* (optional) encrypts all messages in the queue. See xref:mq-understanding.adoc#encrypt-queue[Encrypted queues].
** *Assign a Dead Letter Queue* (optional) assigns the dead letter queue (DLQ).
+
The DLQ is a previously created queue to which to send undeliverable messages. See <<Dead Letter Queues>>.
+
+
. Click *Create Queue*.
. In the *Destinations* screen, click the queue type for the new queue to display its details in the right pane.
+
The details for a queue are:
+
image::mq-queue-details.png[]

== Send a Message to a Queue

Message content (called a payload) can be text, JSON, or CSV (comma-separated values). The maximum size of a message is 10 MB. 

See also <<Send a JSON Message to a Queue>> and <<Send a JSON Message to a Queue>>.

To send a text message to a queue:

. Log into Anypoint Platform.
. Click *MQ* in the left navigation bar or the main Anypoint Platform screen.
. Click *Destinations* in the left pane.
. Click the queue ID or details label to access the Messaging feature:
+
image::mq-queue-details.png[]
+
. In the settings page, click *Message Sender* in the left pane.
. Leave the *Type* field set to *Text*.
. Enter text in the *Payload* field, such as `Hello Mules`.
+
For messages in a standard queue, if you specified *Assign Default Delivery Delay*, you see the default delivery delay. You can override that value for this message or set a delivery delay for a message in a queue without delivery delay. 
+ 
Delivery delay is not supported for individual messages in a FIFO queue.
+
See xref:mq-understanding.adoc#delay_messages[Delivery delay for messages].

. Click *Send*.

== View the Number of Messages in a Queue

You can verify that a message arrived in the queue by viewing the number of messages in the queue from the *Destinations* screen.

To see the number the messages in the queue:

. Click *Destinations* in the left pane.
. Click the queue entry in *Destinations* to view details about the queue in the right pane.
. In the *Destinations* screen, click the queue type for the queue to display its details in the right pane.
+
The detail pane shows the number of messages in the queue:
+
image::mq-msgs-in-queue2.png[]

== Get a Message From a Queue

You can verify that a message arrived by retrieving it from the queue.

To get a message from a queue:

. Log into Anypoint Platform.
. Click *MQ* in the left navigation bar or the main Anypoint Platform screen.
. Click *Destinations* in the left pane.
. Click the queue ID or details label to access the Messaging feature:
+
image::mq-queue-details.png[]
+
. In the settings page, click *Message Browser* in the left pane.
. Click *Get Messages*.
. If you are retrieving messages from a FIFO queue, click the checkbox to acknowledge 
that viewing messages through the browser might cause other consumers of the queue to receive messages out of order.
+
image::mqfifo-message-browser.png[]
+
. Click the message ID value to view the message payload in the right pane.
+
image::mq-click-id2.png[]
+
. If you want to return the message to the queue, for example, if other applications want to read the message, click the *Return Messages* icon:
+
image::mq-click-retmsgs2.png[]
+
If you switch screens back to the *Message Sender* or *Destinations* screens, messages automatically return to the queue.
+
Returning the messages to the queue is a not-acknowledgment (NACK). The message is not altered. However,
the time to live (TTL) value you set when you created the queue determines how long the message is available before Anypoint MQ deletes it.
+
Alternatively, you can delete the message by clicking the trash can icon in the details pane. 
+
image::mq-message-delete-trash-can-icon2.png[]

Deleting a message is an acknowledgment (ACK). For information about how Anypoint MQ processes ACK messages, see xref:mq-ack-mode.adoc[Acknowledge Messages].

== Send a JSON Message to a Queue

To send a JSON message to a queue:

. Log into Anypoint Platform.
. Click *MQ* in the left navigation bar or the main Anypoint Platform screen.
. Click *Destinations* in the left pane.
. Click the queue ID or details label to access the Messaging feature.
. In the settings page, click *Message Sender* in the left pane.
. Set the *Type* to *JSON*.
. Enter this text in the *Payload* field:
+
[source,json,linenums]
----
{
"animal that walks":"dog",
"animal that swims":"fish",
"animal that flies":"parrot"
}
----
+
. Click *Send*.
. Click *Message Browser*, and then click *Get Messages*.
. Click the message ID to view the message:
+
image::mq-json-get-msg2.png[]

== Send a CSV Message to a Queue

To send a CSV message to a queue:

. Log into Anypoint Platform.
. Click *MQ* in the left navigation bar or the main Anypoint Platform screen.
. Click *Destinations* in the left pane.
. Click the queue ID or details label to access the Messaging feature.
. In the settings page, click *Message Sender* in the left pane.
. Set the *Type* to *CSV*.
. Enter this text in the *Payload* field:
+
----
"dog",
"fish",
"parrot"
----
+
. Click *Send*.
. Click *Message Browser*, and then click *Get Messages*.
. Click the message ID to view the message:
+
image::mq-csv-get-msg2.png[]


== Purge Messages from a Queue

You can purge all the messages in the queue by clicking the *Purge Messages* icon in the details pane:

image::mqfifo-purge-msgs-icon.png[]

An alert message appears. Click the checkbox and then Delete *Messages* to verify that you want to purge all messages in the queue:

image::mqfifo-purge-messages.png[]

== Delete a Queue

If a queue is no longer needed, you can delete it. Any in-flight messages in the deleted queue are lost. You can't recover a deleted queue.

To delete a queue:

. Click *Destinations*.
. In the *Destinations* screen, click the queue type for the queue to display its details in the right pane.
. Click the trash can icon in the upper right.
+
image::mq-click-type-q2.png[]
+
. In the *Delete Queue* popup, click the checkbox:
+
image::mq-delete-queue.png[]
+
. Click *Delete Queue*.
+
The time it takes to delete or purge a queue is approximately one minute. During this time, the status of the affected queue can't be updated.


[[fifoqueues]]
== FIFO Queues

For applications where the order of messages must be strictly preserved and enforced, Anypoint MQ provides first in, first out (FIFO) processing to enable message ordering. With FIFO queues, Anypoint MQ ensures that the order in which messages are placed in a queue is the same order messages are retrieved.

FIFO queues: 

* Are limited to 300 TPS (transactions per second). 
+
However, if you batch 10 messages per each read and write operation (maximum) using the API, FIFO queues can support up to 3,000 TPS.
* Support delivery delay on all messages in the FIFO queue. 
+
If you change the delivery delay for a FIFO queue, the setting change is retroactive to all messages in the queue. Delivery delay is not supported for individual messages in a FIFO queue. 
* Provide  encryption.
+
Encrypting a FIFO queue does not affect the order or the contents of messages consumed.
* Can be used as a DLQ.
+
When assigning a DLQ to a FIFO queue, the DLQ must also be a FIFO queue.
* Cannot be bound to a message exchange.

To create a FIFO queue, see <<Create a Queue>>. To determine if a queue is FIFO or non-FIFO, view its details. 

See the xref:mq-faq#regions[Anypoint MQ FAQ] for the regions where Anypoint MQ and FIFO queues are available.

For information about creating FIFO queues with the Admin API, see xref:mq-apis.adoc#create-a-fifo-queue-in-the-admin-api-portal[Create a FIFO Queue in the Admin API Portal].

=== FIFO Exactly-Once Delivery

For applications where messages must be processed exactly once, such as those used in transactional use cases, FIFO queues ensure exactly-once message delivery.

FIFO queues provide message deduplication. If multiple messages are sent to a FIFO queue containing the same message ID, the first message to arrive is kept as the valid message. Subsequent messages within the deduplication interval of 5 minutes are considered duplicates and are discarded. For example, after the queue sees a message with ID `12345` arrives in the queue, for the next 5 minutes, the FIFO queue discards any messages with the ID `12345`.

When building applications in Anypoint Studio that require exactly-once delivery, you can either:

* Set the message ID in the publisher settings in the Anypoint MQ connector.
* Let Anypoint MQ auto-generate a unique message ID for each message sent to a queue (default).

== Dead Letter Queues

Anypoint MQ provides the ability to ensure that messages that aren't delivered are sent to a queue known as the dead letter queue (DLQ). You can then analyze the messages sent to the DLQ to determine why those messages were not delivered. 

A DLQ is essentially the same as any other queue except that it receives only undelivered messages. You can specify the time to live (TTL) value, encryption, and delivery delay when you create the queue. 

You can't assign a single queue to be the dead letter queue. You must create at least two queues to be able to assign one as a DLQ. The DLQ must be the same type (standard or FIFO) as the queue writing to it.

Both the DLQ and the queue writing to it must be in the same geographical xref:mq-faq.adoc#regions[region] and environment and owned by the same Anypoint Platform account.

=== Encryption

Undeliverable messages that re-route to the DLQ use the encryption set for the source queue, regardless of the DLQ encryption setting. Messages sent directly to the DLQ by a client use the encryption setting for the DLQ. If your organization's policy is that all messages are encrypted, then you must set encryption for all queues.

=== Billing and Maximum Deliveries

If a message sent to the DLQ is a dead letter from another queue, the message is not charged against the billable message units. However, if a client sends a message directly to a DLQ, those messages are charged.

If a queue has a dead letter queue assigned:

* Viewing the messages in the source queue using the Anypoint MQ *Message Browser* counts against the number of maximum deliveries.
* Viewing a message and returning it to the queue counts as a NACK operation, and is considered an unsuccessful delivery attempt.
* Deleting the message in the *Message Browser* prevents it from being counted against the maximum deliveries, but the message is lost.

=== How Messages Are Sent to a DLQ

This flowchart shows how messages are sent to a DLQ:

image::mq-dlq-flowchart.png[]

=== Assign a DLQ to a Queue

You can assign any queue as a DLQ for another queue as long as it's the same type and in the same region and environment. 

* Messages sent to a FIFO DLQ must originate from a FIFO queue. 
* Messages sent to a non-FIFO DLQ must originate from a non-FIFO queue.
+ 
See <<fifoqueues,FIFO Queues>>.

To assign a DLQ to a queue:

. <<Create a Queue,Create a queue>>. 
. Toggle *Assign a Dead Letter Queue* to *On*.
+
The following additional fields appear:

image::mq-create-q-dlq.png[]

* *Dead Letter Queue Name* 
+
Choose a previously created queue name from the drop-down list.
* *Reroute after 10 attempts* (Optional)
+
Specify how many attempts Anypoint MQ tries to deliver messages in the queue before rerouting the message to the dead letter queue. If not specified, the default value is 10 tries. This value ranges from 1 to 1000 attempts.

=== Recover Messages from a DLQ

You can recover messages from the DLQ, use the REST API to get the message from the queue and write the message to a new queue. See xref:mq-apis.adoc#mqadminapi[Anypoint MQ Admin API].

=== Determine Whether a Queue is a DLQ

You can see whether any other queues are using a queue as a DLQ by viewing its details:

image::mq-queue-view-dlq.png[]

You can also view details of each queue from the REST Administration API, using the Get Queue REST endpoint. 

[source,json,linenums]
----
{
 "encrypted": false,
 "type": "queue",
 "queueId": "my-dlq-1",
 "deadLetterSources": [
   "my-queue-4",
   "my-dls-1"
 ],
 "defaultTtl": 2000000,
 "defaultLockTtl": 2000000
}
----

If DLQ is set, the returned entities contain the `deadLetterSources` field. 

For more information, see xref:mq-apis.adoc#mqadminapi[Anypoint MQ Admin API].

== See Also

* xref:mq-faq.adoc[Anypoint MQ FAQ]
* xref:mq-exchanges.adoc[Configure Message Exchanges]
* xref:mq-connectors.adoc[Anypoint MQ Connectors]
